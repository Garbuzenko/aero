# Модуль прогнозирования полетов БПЛА (Prediction)

## Описание

Модуль `prediction.py` предназначен для создания прогнозов полетов беспилотных летательных аппаратов (БПЛА) на основе исторических данных и экспертных оценок. Модуль анализирует исторические данные о полетах из таблицы `processed_flights` и генерирует предсказания на указанный период с учетом темпов роста рынка дронов.

## Основные возможности

### 1. Два режима прогнозирования

#### Режим экспертной оценки (по умолчанию)
- Использует прогноз эксперта о росте рынка дронов
- **Прогноз эксперта**: рост числа легальных полетов дронов в России **в 10 раз к 2030 году относительно 2023 года**
- Автоматически рассчитывает среднемесячный темп роста на основе целевого показателя
- Учитывает уже достигнутый рост с 2023 года
- Применяет кумулятивный рост для каждого прогнозируемого месяца

#### Режим исторических данных
- Анализирует фактические темпы роста из базы данных
- Рассчитывает среднемесячный прирост на основе исторических трендов
- Подходит для краткосрочных прогнозов

### 2. Интеллектуальная генерация данных

- **Базирование на последнем годе**: использует данные только за последний доступный год для каждого месяца
- **Кумулятивный рост**: каждый следующий месяц учитывает накопленный рост
- **Сохранение паттернов**: копирует характеристики реальных полетов (типы ВС, регионы, время суток)
- **Вариативность**: добавляет случайные отклонения во времени и длительности полетов

### 3. Автоматическое управление данными

- Удаление старых прогнозов перед генерацией новых
- Пакетная вставка данных для оптимизации производительности
- Валидация и обработка ошибок
- Детальное логирование процесса

## Структура класса FlightPredictorNew

```python
FlightPredictorNew(
    db_config,                    # Конфигурация базы данных
    use_expert_forecast=True,     # Использовать прогноз эксперта
    target_year=2030,             # Целевой год прогноза
    growth_multiplier=10          # Ожидаемый рост (в N раз)
)
```

## Параметры настройки (таблица settings)

Модуль использует следующие параметры из таблицы `settings`:

| Параметр | Описание | По умолчанию |
|----------|----------|--------------|
| `prediction_start` | Дата начала прогнозируемого периода | `2025-08-01` |
| `prediction_end` | Дата окончания прогнозируемого периода | `2026-12-31` |
| `use_expert_forecast` | Использовать экспертный прогноз (true/false) | `true` |
| `forecast_target_year` | Целевой год для прогноза эксперта | `2030` |
| `forecast_growth_multiplier` | Ожидаемый рост к целевому году (множитель) | `10` |

### Пример добавления настроек в БД

```sql
INSERT INTO settings (key_name, value, description) VALUES
('prediction_start', '2025-08-01', 'Дата начала прогнозируемого периода'),
('prediction_end', '2026-12-31', 'Дата окончания прогнозируемого периода'),
('use_expert_forecast', 'true', 'Использовать экспертный прогноз'),
('forecast_target_year', '2030', 'Целевой год для достижения прогноза'),
('forecast_growth_multiplier', '10', 'Ожидаемый рост в N раз к целевому году');
```

## Алгоритм работы

### Этап 1: Инициализация
1. Подключение к базе данных
2. Чтение параметров из таблицы `settings`
3. Настройка режима прогнозирования

### Этап 2: Загрузка исторических данных
1. Загрузка всех записей с `prediction='download'` начиная с 2024 года
2. Валидация и очистка данных
3. Группировка по месяцам для анализа

### Этап 3: Расчет темпа роста

#### В режиме экспертной оценки:
Формула кумулятивного роста относительно базового 2023 года:
```
1. Рассчитываем базовое значение (среднее за 2023 год)
2. Рассчитываем текущее значение (среднее за последний период)
3. Определяем уже достигнутый рост: current / base
4. Определяем целевое значение: base × 10
5. Рассчитываем оставшийся рост: target / current
6. Определяем темп роста: remaining_growth^(1/months_to_target) - 1
```

**Пример расчета для 10x роста к 2030 году от уровня 2023:**
- Базовый год: 2023 (например, 500 полетов/месяц)
- Текущий период: июль 2025 (например, 750 полетов/месяц)
- Уже достигнутый рост: в 1.5 раза (50%)
- Целевое значение к 2030: 5,000 полетов/месяц (10x от 2023)
- Оставшийся рост: в 6.67 раза (от 750 до 5,000)
- Месяцев до цели: ~65 месяцев
- Среднемесячный темп роста: ~3.0%
- Среднегодовой темп роста: ~42.6%

#### В режиме исторических данных:
```
avg_growth = mean([(month[i] - month[i-1]) / month[i-1]])
```

### Этап 4: Генерация прогнозов по месяцам

Для каждого месяца в периоде прогноза:

1. **Выборка базовых данных**:
   - Берутся данные за этот месяц из последнего доступного года
   - Если данных нет, используется среднее за последний год

2. **Расчет ожидаемого количества**:
   ```
   cumulative_growth = (1 + growth_rate)^months_from_last - 1
   expected_count = base_count × (1 + cumulative_growth)
   ```

3. **Генерация записей**:
   - Случайный выбор (с повторениями при необходимости) базовых записей
   - Обновление дат на прогнозируемый период
   - Добавление вариативности во времени и длительности
   - Генерация новых идентификаторов

### Этап 5: Сохранение результатов

- Пакетная вставка данных (по 10,000 записей)
- Все прогнозы помечаются как `prediction='prediction'`
- Автоматическая обработка ошибок и rollback при сбое

## Формат данных

### Входные данные (processed_flights)

Используются записи с `prediction='download'`:
- Даты полетов (`dof_date`, `planned_date`, `departure_actual_date`, `arrival_actual_date`)
- Время (`atd_time`, `ata_time`, `departure_actual_time`, `arrival_actual_time`)
- Характеристики ВС (`aircraft_type_code`, `aircraft_type_desc`)
- Регионы (`region_id`, `departure_region`, `arrival_region`)
- Координаты (`departure_lat`, `departure_lon`, `arrival_lat`, `arrival_lon`)
- Прочие параметры (оператор, регистрация, длительность и т.д.)

### Выходные данные

Записи в `processed_flights` с полями:
- `prediction='prediction'` - маркер прогнозных данных
- Обновленные даты в прогнозируемом периоде
- Уникальные идентификаторы (`source_id`, `flight_id`)
- Имя файла: `prediction_YYYY_MM.xlsx`
- Автоматически рассчитанное время суток (`time_of_day`)

## Использование

### Запуск из командной строки

```bash
cd prediction
python prediction.py
```

### Программное использование

```python
from prediction import FlightPredictorNew
import settings

# Использование экспертного прогноза (рост в 10 раз к 2030)
predictor = FlightPredictorNew(
    settings.DB_CONFIG,
    use_expert_forecast=True,
    target_year=2030,
    growth_multiplier=10
)

# Запуск с параметрами из настроек
success = predictor.generate_predictions()

# Или с явным указанием периода
success = predictor.generate_predictions(
    prediction_start='2025-08-01',
    prediction_end='2026-12-31'
)
```

### Использование исторических данных

```python
# Режим исторического анализа
predictor = FlightPredictorNew(
    settings.DB_CONFIG,
    use_expert_forecast=False
)
success = predictor.generate_predictions()
```

## Примеры прогнозов

### Пример 1: Рост на основе экспертной оценки (10x к 2030 от уровня 2023)

**Исходные данные:**
- 2023 год: 500 полетов/месяц (базовый уровень)
- Июль 2025: 750 полетов/месяц (уже +50% от 2023)
- Цель к 2030: 5,000 полетов/месяц (10x от 2023)

**Прогноз на 2025-2026:**
```
Август 2025:     773 полетов (+3.0% от июля, 1.55x от 2023)
Сентябрь 2025:   796 полетов (+6.1% от июля, 1.59x от 2023)
Октябрь 2025:    820 полетов (+9.3% от июля, 1.64x от 2023)
Ноябрь 2025:     845 полетов (+12.7% от июля, 1.69x от 2023)
Декабрь 2025:    870 полетов (+16.0% от июля, 1.74x от 2023)
...
Июнь 2026:      1,069 полетов (+42.5% от июля 2025, 2.14x от 2023)
Декабрь 2026:   1,240 полетов (+65.3% от июля 2025, 2.48x от 2023)
```

### Пример 2: Долгосрочный прогноз (траектория к 10x)

**Траектория роста от 2023 к 2030:**
- 2023: 500 полетов/месяц (базовый уровень, 1.0x)
- 2024: ~600 полетов/месяц (1.2x)
- 2025: ~750 полетов/месяц (1.5x)
- 2026: ~1,200 полетов/месяц (2.4x)
- 2027: ~1,900 полетов/месяц (3.8x)
- 2028: ~3,000 полетов/месяц (6.0x)
- 2029: ~4,000 полетов/месяц (8.0x)
- 2030: ~5,000 полетов/месяц (10.0x - достижение цели)

## Логирование

Модуль ведет подробное логирование процесса:

```
2025-10-19 12:00:00 - INFO - Запуск генерации предсказаний...
2025-10-19 12:00:01 - INFO - Дата начала прогноза из настроек: 2025-08-01
2025-10-19 12:00:01 - INFO - Дата окончания прогноза из настроек: 2026-12-31

╔══════════════════════════════════════════════════════╗
║         ПРОГНОЗ НА ОСНОВЕ ЭКСПЕРТНОЙ ОЦЕНКИ          ║
╠══════════════════════════════════════════════════════╣
║  Последние данные: 2025-07                           ║
║  Целевой год: 2030                                   ║
║  Ожидаемый рост: в 10 раз (1000%)                    ║
║  Период прогноза: 65 месяцев                         ║
║  Среднемесячный темп: 3.66%                          ║
║  Среднегодовой темп: 53.9%                           ║
╚══════════════════════════════════════════════════════╝

2025-10-19 12:00:05 - INFO - Загружено 12000 исторических записей
2025-10-19 12:00:10 - INFO - Для месяца 8/2025 сгенерировано 1037 записей
2025-10-19 12:00:15 - INFO - Для месяца 9/2025 сгенерировано 1075 записей
...
2025-10-19 12:05:00 - INFO - Предсказания успешно сгенерированы и сохранены
```

Логи сохраняются в файл `../prediction.log`.

## Особенности реализации

### Обработка времени суток
Модуль автоматически определяет время суток с учетом UTC региона:
- **Утро**: 6:00 - 12:00
- **День**: 12:00 - 18:00
- **Вечер**: 18:00 - 00:00
- **Ночь**: 0:00 - 6:00

### Генерация уникальных идентификаторов
Каждая прогнозная запись получает:
- `source_id`: `pred_XXXXXX` (случайное 6-значное число)
- `flight_id`: `PREDXXXXXXX` (случайное 7-значное число)
- `uniq_str`: комбинация всех ключевых полей для анализа дубликатов

### Вариативность данных
Для реалистичности прогнозов добавляются случайные отклонения:
- Время вылета/прибытия: ±2 часа ±30 минут
- Длительность полета: ±30 минут
- Дата в пределах месяца: случайный день

## Производительность

- **Скорость обработки**: ~1,000-2,000 записей в секунду
- **Пакетная вставка**: 10,000 записей за один запрос
- **Оптимизация памяти**: данные обрабатываются пакетами
- **Логирование прогресса**: каждые 1,000 записей

## Требования

### Python библиотеки
```
mysql-connector-python
pandas
numpy
```

### Структура базы данных
- Таблица `processed_flights` с полями согласно схеме
- Таблица `settings` для хранения параметров
- Таблица `regions` с UTC offset'ами регионов

## Устранение неполадок

### Проблема: Нет роста количества записей
**Решение**: Обновлена логика выборки базовых данных - теперь используются только данные за последний год для каждого месяца.

### Проблема: Слишком быстрый/медленный рост
**Решение**: Настройте параметры `forecast_target_year` и `forecast_growth_multiplier` в таблице `settings`.

### Проблема: Ошибки вставки данных
**Решение**: Проверьте структуру таблицы `processed_flights` и совместимость полей.

## Дальнейшее развитие

Возможные улучшения:
- [ ] Прогнозирование с учетом сезонности
- [ ] Учет региональных особенностей роста
- [ ] Прогнозирование по типам БПЛА отдельно
- [ ] Интеграция с внешними источниками данных
- [ ] Машинное обучение для более точных прогнозов
- [ ] Web-интерфейс для управления параметрами

## Авторы и лицензия

Разработано для проекта анализа полетов БПЛА в рамках хакатона 2025.

---

**Последнее обновление**: 19 октября 2025  
**Версия**: 2.0

